<!DOCTYPE html>
<html lang="de">

<head>
    <link rel="stylesheet" href="style.css">
    <title>Sachkosten</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <script src="validation.js"></script>
    <!--<script src="script.js"></script>-->
    <script src="buttonScript.js"></script>
    <script defer src="particles.js"></script>
</head>

<body class="taskMain">
    <header class="headerBanner">
        <h1>Kosten für projektbezogene Leistungen</h1>
        <div class="logoutButtonContainer">
            <button class="logoutButton" id="logoutButton">Abmelden</button>
        </div>
        <div class="tabsContainer">
            <div class="tabs" id="tabs">
                <a href="allgemein.html" class="tab">Allgemeine Projektdaten</a>
                <a href="personalkosten.html" class="tab">Personalkosten</a>
                <a href="leistungen.html" class="tabActive">Kosten für projektbezogene Leistungen</a>
                <a href="sachkosten.html" class="tab">Sachkosten</a>
                <a href="abschreibungen.html" class="tab">Investitionen/Abschreibungen</a>
                <a href="raeume.html" class="tab">Kosten für Räume und Flächen</a>
            </div>
            <select class="tabsDropdown" id="tabsDropdown">
                <option value="allgemein.html">Allgemeine Projektdaten</option>
                <option value="personalkosten.html">Personalkosten</option>
                <option value="leistungen.html" selected>Kosten für projektbezogene Leistungen</option>
                <option value="sachkosten.html">Sachkosten</option>
                <option value="abschreibungen.html">Investitionen/Abschreibungen auf Geräte und Ausstattung</option>
                <option value="raeume.html">Kosten für Räume und Flächen</option>
            </select>
        </div>
    </header>

    <main>
        <script>
            const tabs = document.getElementById('tabs');
            const dropdown = document.getElementById('tabsDropdown');

            const changeWidth = 1500;
            let tooSmall = window.innerWidth <= changeWidth;

            function animateSwitch(showDropdown) {
                if (showDropdown) {
                    tabs.classList.add('tabsHidden');
                    dropdown.classList.remove('dropdownHidden');
                } else {
                    tabs.classList.remove('tabsHidden');
                    dropdown.classList.add('dropdownHidden');
                }
            }

            window.addEventListener('resize', () => {
                const isSmall = window.innerWidth <= changeWidth;
                if (isSmall !== tooSmall) {
                    animateSwitch(isSmall);
                    tooSmall = isSmall;
                }
            });

            window.addEventListener('DOMContentLoaded', () => {
                if (tooSmall) {
                    tabs.classList.add('tabsHidden');
                    dropdown.classList.remove('dropdownHidden');
                } else {
                    dropdown.classList.add('dropdownHidden');
                }

                requestAnimationFrame(() => {
                    tabs.classList.add('navTransition');
                    dropdown.classList.add('navTransition');
                });
            });

            dropdown.addEventListener('change', function () {
                window.location.href = this.value;
            });
        </script>

        <form class="projectForm" action="abschreibungen.html" method="post">
            <div>
                <p>Werkvertäge</p>
            </div>
            <div class="formRow">
                <div class="formGroup">
                    <label for="workContract25">2025</label>
                    <input type="numbers" id="workContract25" data-validate-regex="^\d+([.,]\d{1,2})?$"
                        data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="Werkvetrag 2025"
                        placeholder="0">
                    <span id="workContract25Error" class="error-message"></span>
                    <span class="tooltipText">Auftragverhältnisse mit externen zur Erbringung klar definierter
                        Leistungen</span>
                </div>
                <div class="formGroup">
                    <label for="workContract26">2026</label>
                    <input type="numbers" id="workContract26" data-validate-regex="^\d+([.,]\d{1,2})?$"
                        data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="Werkvertrag 2026"
                        placeholder="0">
                    <span id="workContract26Error" class="error-message"></span>
                </div>
                <div class="formGroup">
                    <label for="workContract27">2027</label>
                    <input type="numbers" id="workContract27" data-validate-regex="^\d+([.,]\d{1,2})?$"
                        data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="Werkvertrag 2027"
                        placeholder="0">
                    <span id="workContract27Error" class="error-message"></span>
                </div>
            </div>
            <div>
                <p>Wissenschaftliche Dienstleistungen</p>
            </div>
            <div class="formRow">
                <div class="formGroup">
                    <label for="scientificService25">2025</label>
                    <input type="numbers" id="scientificService25" data-validate-regex="^\d+([.,]\d{1,2})?$"
                        data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="scientificService25"
                        placeholder="0">
                    <span id="scientificService25Error" class="error-message"></span>
                    <span class="tooltipText">Externe Dienstleistungen mit wissenschaftlichem Bezug</span>
                </div>
                <div class="formGroup">
                    <label for="scientificService26">2026</label>
                    <input type="numbers" id="scientificService26" data-validate-regex="^\d+([.,]\d{1,2})?$"
                        data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="scientificService26"
                        placeholder="0">
                    <span id="scientificService26Error" class="error-message"></span>
                </div>
                <div class="formGroup">
                    <label for="scientificService27">2027</label>
                    <input type="numbers" id="scientificService27" data-validate-regex="^\d+([.,]\d{1,2})?$"
                        data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="scientificService27"
                        placeholder="0">
                    <span id="scientificService27Error" class="error-message"></span>
                </div>
            </div>
            <div>
                <p>Sonstige Fremdleistungen (keine Lieferungen)</p>
            </div>
            <div class="formRow">
                <div class="formGroup">
                    <label for="thirdPartyServices25">2025</label>
                    <input type="numbers" id="thirdPartyService25" data-validate-regex="^\d+([.,]\d{1,2})?$"
                        data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="thirdPartyService25"
                        placeholder="0">
                    <span id="thirdPartyService25Error" class="error-message"></span>
                    <span class="tooltipText">Dienste externer Anbieter, keine physischen Produkte oder Geräte.</span>
                </div>
                <div class="formGroup">
                    <label for="thirdPartyService26">2026</label>
                    <input type="numbers" id="thirdPartyService26" data-validate-regex="^\d+([.,]\d{1,2})?$"
                        data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="thirdPartyService26"
                        placeholder="0">
                    <span id="thirdPartyService26Error" class="error-message"></span>
                </div>
                <div class="formGroup">
                    <label for="thirdPartyService27">2027</label>
                    <input type="numbers" id="thirdPartyService27" data-validate-regex="^\d+([.,]\d{1,2})?$"
                        data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="thirdPartyService27"
                        placeholder="0">
                    <span id="thirdPartyService27Error" class="error-message"></span>
                </div>
            </div>
            <div class="formRow formRowRigth">
                <button type="submit" class="weiterButton" id="submitButton">Weiter</button>
            </div>
        </form>

    </main>
    <footer class="footer">
        <p>&copy; 2025 Hochschule Mittweida</p>
        <canvas id="canvas"></canvas>
    </footer>
</body>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        let projectId = urlParams.get('projectId') || localStorage.getItem("projectId");

        if (!projectId) {
            console.warn("Kein projectId vorhanden.");
            return;
        }

        localStorage.setItem("projectId", projectId);

        fetch(`php/loadProject.php?projectId=${encodeURIComponent(projectId)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Fehler beim Laden: " + data.error);
                    return;
                }

                Object.entries(data).forEach(([key, value]) => {
                    const el = document.getElementById(mapField(key));
                    if (el) {
                        el.value = value;
                    }
                });
            })
            .catch(err => {
                console.error("Fehler beim Laden:", err);
                alert("Projekt konnte nicht geladen werden.");
            });

        function mapField(dbKey) {
            const fieldMap = {
                "C_workContract25": "workContract25",
                "C_workContract26": "workContract26",
                "C_workContract27": "workContract27",
                "C_scientificService25": "scientificService25",
                "C_scientificService26": "scientificService26",
                "C_scientificService27": "scientificService27",
                "C_thirdPartyService25": "thirdPartyService25",
                "C_thirdPartyService26": "thirdPartyService26",
                "C_thirdPartyService27": "thirdPartyService27"
            };
            return fieldMap[dbKey] || dbKey;
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('form.projectForm');
        const submitButton = document.getElementById('submitButton');
        const fieldMap = {
            workContract25: "C_workContract25",
            workContract26: "C_workContract26",
            workContract27: "C_workContract27",
            scientificService25: "C_scientificService25",
            scientificService26: "C_scientificService26",
            scientificService27: "C_scientificService27",
            thirdPartyService25: "C_thirdPartyService25",
            thirdPartyService26: "C_thirdPartyService26",
            thirdPartyService27: "C_thirdPartyService27",
        };

        if (!form || !submitButton) return;

        submitButton.addEventListener('click', function (e) {
            e.preventDefault();
            const projectId = localStorage.getItem("projectId");
            if (!projectId) {
                alert("Projekt-ID fehlt.");
                return;
            }
            let sum = parseFloat(workContract25.value.replace(".", ",")) || 0 +
                parseFloat(workContract26.value.replace(".", ",")) || 0 +
                parseFloat(workContract27.value.replace(".", ",")) || 0 +
                parseFloat(scientificService25.value.replace(".", ",")) || 0 +
                parseFloat(scientificService26.value.replace(".", ",")) || 0 +
                parseFloat(scientificService27.value.replace(".", ",")) || 0 +
                parseFloat(thirdPartyService25.value.replace(".", ",")) || 0 +
                parseFloat(thirdPartyService26.value.replace(".", ",")) || 0 +
                parseFloat(thirdPartyService27.value.replace(".", ",")) || 0;
            const formData = new FormData();
            for (const [htmlId, dbColumn] of Object.entries(fieldMap)) {
                const field = document.getElementById(htmlId);
                if (field) {
                    formData.append(dbColumn, field.value);
                }
            }
            console.log("Formulardaten:", Object.fromEntries(formData.entries()));
            formData.append("G_sumLeistungen", sum);
            formData.append("projectId", projectId);
            fetch("php/saveProject.php", {
                method: "POST",
                body: formData
            })
                .then(res => res.text())
                .then(result => {
                    console.log("Server response:", result);
                })
                .catch(err => {
                    console.error("Fehler beim Speichern:", err);
                    alert("Speichern fehlgeschlagen.");
                });
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const urlProjectId = urlParams.get('projectId');
        const localProjectId = localStorage.getItem("projectId");

        if (urlProjectId) {
            localStorage.setItem("projectId", urlProjectId);
        }

        const projectId = urlProjectId || localProjectId;

        if (!projectId) {
            console.warn("Keine projectId gefunden");
            return;
        }

        // Tabs updaten
        const links = document.querySelectorAll('.tabs a');
        links.forEach(link => {
            const url = new URL(link.href, window.location.origin);
            url.searchParams.set('projectId', projectId);
            link.href = url.toString();
        });

        // Dropdown-Optionen updaten
        const dropdown = document.getElementById("tabsDropdown");
        if (dropdown) {
            Array.from(dropdown.options).forEach(option => {
                if (option.value) {
                    const url = new URL(option.value, window.location.origin);
                    url.searchParams.set('projectId', projectId);
                    option.value = url.pathname + url.search;
                }
            });
        }
    });
</script>

</html>