<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Personalkosten</title>
        <link rel="stylesheet" href="style.css">
        <script src="validation.js"></script>
        <script src="script.js"></script>
        <script src="buttonScript.js"></script>
        <script src="neuerMitarbeiter.js"></script>
        <script defer src="particles.js"></script>
        <script src="neuerMitarbeiter2.js"></script>
    </head>
    <body class="taskMain">
        <header class="headerBanner">
            <div class="header">
                <h1>KostenKalkulationstool</h1>
            </div>
            <div class="logoutButtonContainer">
                    <button class="logoutButton" id="logoutButton">Abmelden</button>
            </div>
            <div class="tabsContainer">
                <div class="tabs" id="tabs">
                    <a href="allgemein.html" class="tab">Allgemeine Projektdaten</a>
                    <a href="personalkosten.html" class="tabActive">Personalkosten</a>
                    <a href="leistungen.html" class="tab">Kosten für projektbezogene Leistungen</a>
                    <a href="sachkosten.html" class="tab">Sachkosten</a>
                    <a href="abschreibungen.html" class="tab">Investitionen/Abschreibungen</a>
                    <a href="raeume.html" class="tab">Kosten für Räume und Flächen</a>
                </div>
                <select class="tabsDropdown" id="tabsDropdown">
                    <option value="allgemein.html">Allgemeine Projektdaten</option>
                    <option value="personalkosten.html"selected>Personalkosten</option>
                    <option value="leistungen.html">Kosten für projektbezogene Leistungen</option>
                    <option value="sachkosten.html">Sachkosten</option>
                    <option value="abschreibungen.html" >Investitionen/Abschreibungen auf Geräte und Ausstattung</option>
                    <option value="raeume.html">Kosten für Räume und Flächen</option>
                </select>
            </div>
        </header>

    <main>
        <script>
            const tabs = document.getElementById('tabs');
            const dropdown = document.getElementById('tabsDropdown');

            const changeWidth = 1500;
            let tooSmall = window.innerWidth <= changeWidth;

            function animateSwitch(showDropdown) {
                if (showDropdown) {
                    tabs.classList.add('tabsHidden');
                    dropdown.classList.remove('dropdownHidden');
                } else {
                    tabs.classList.remove('tabsHidden');
                    dropdown.classList.add('dropdownHidden');
                }
            }

            window.addEventListener('resize', () => {
                const isSmall = window.innerWidth <= changeWidth;
                if (isSmall !== tooSmall) {
                    animateSwitch(isSmall);
                    tooSmall = isSmall;
                }
            });

            window.addEventListener('DOMContentLoaded', () => {
                if (tooSmall) {
                    tabs.classList.add('tabsHidden');
                    dropdown.classList.remove('dropdownHidden');
                } else {
                    dropdown.classList.add('dropdownHidden');
                }

                requestAnimationFrame(() => {
                    tabs.classList.add('navTransition');
                    dropdown.classList.add('navTransition');
                });
            });

            dropdown.addEventListener('change', function () {
                window.location.href = this.value;
            });
        </script>

        <div class="mainContent">
            <form class="projectForm" id="personalForm" action="personal.php" method="post" style="display: none;">

                <!-- SHK/ WHK -->
                <div class="formRow">
                    <div class="formGroup">
                        <label for="hk">SHK/ WHK</label>
                        <select id="hk" name="hk">
                            <option value="SHK">Studentische Hilfskraft</option>
                            <option value="WHK">Wissenschaftliche Hilfskraft</option>
                        </select>
                    </div>
                </div>

                <!-- Entgeltgruppe -->
                <div class="formRow">
                    <div class="formGroup">
                        <label for="entgeltgr">Entgeltgruppe</label>
                        <select id="entgeltgr" name="entgeltgr">
                            <option value="E 01">E 01</option>
                            <option value="E 02">E 02</option>
                            <option value="E 03">E 03</option>
                            <option value="E 04">E 04</option>
                            <option value="E 05">E 05</option>
                            <option value="E 06">E 06</option>
                            <option value="E 07">E 07</option>
                            <option value="E 08">E 08</option>
                            <option value="E 09">E 09</option>
                            <option value="E 10">E 10</option>
                            <option value="E 11">E 11</option>
                            <option value="E 12">E 12</option>
                            <option value="E 13">E 13</option>
                            <option value="E 14">E 14</option>
                            <option value="E 15">E 15</option>
                        </select>
                    </div>
                </div>

                <!-- Stufe/ Std. satz -->
                <div class="formRow">
                    <div class="formGroup">
                        <label for="stufe">Stufe/ Std. satz</label>
                        <select id="stufe" name="stufe">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                        <!-- <input type="numbers" id="stufe" data-validate-regex= "^\d+([.,]\d{1,2})?$" data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="Stufe">
                            <span id="stufeError" class="error-message"></span>-->
                    </div>
                </div>


                <!-- 2025, 2026, 2027 -->
                <div class="formRow">
                    <div class="formGroup">
                        <label for="jahr2025">2025</label>
                        <input type="numbers" id="jahr2025" data-validate-regex="^\d+([.,]\d{1,2})?$"
                            data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="Jahr 2025">
                        <span id="jahr2025Error" class="error-message"></span>
                    </div>
                    <div class="formGroup">
                        <label for="jahr2026">2026</label>
                        <input type="numbers" id="jahr2026" data-validate-regex="^\d+([.,]\d{1,2})?$"
                            data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="Jahr 2026">
                        <span id="jahr2026Error" class="error-message"></span>
                    </div>
                    <div class="formGroup">
                        <label for="jahr2027">2027</label>
                        <input type="numbers" id="jahr2027" data-validate-regex="^\d+([.,]\d{1,2})?$"
                            data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="Jahr 2027">
                        <span id="jahr2027Error" class="error-message"></span>
                    </div>
                </div>

                <!-- Wochenstunden im Projekt -->
                <div class="formRow">
                    <div class="formGroup">
                        <label for="wochenstunden">Wochenstunden im Projekt</label>
                        <input type="numbers" id="wochenstunden" data-validate-regex="^\d+([.,]\d{1,2})?$"
                            data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="Wochenstunden">
                        <span id="wochenstundenError" class="error-message"></span>
                    </div>
                </div>

                <!-- Submit -->
                <div class="formRow formRowRigth">
                    <button type="button" class="weiterButton" id="saveButton1">Hinzufügen</button>
                </div>
            </form>


            <!-- haushaltfinanz. Hochschul-Mitarbeiter -->
            <form2 class="projectForm" id="personalForm2" action="personal.php" method="post" style="display: none;">

                <!-- Entgeltgruppe -->
                <div class="formRow">
                    <div class="formGroup">
                        <label for="entgeltgr">Entgeltgruppe</label>
                        <select id="entgeltgr" name="entgeltgr">
                            <option value="E 01 - 04">E 01 - 04</option>
                            <option value="E 05 - 08">E 05 - 08</option>
                            <option value="E 09 - 12">E 09 - 12</option>
                            <option value="E 13 - 15">E 13 - 15</option>
                        </select>
                    </div>
                </div>

                <!-- 2025 -->
                <div class="formRow">
                    <div>2025</div>
                    <div class="formGroup">
                        <label for="anzahlPersonen2025">Anzahl Personen</label>
                        <input type="numbers" id="anzahlPersonen2025" data-validate-regex="^\d+$"
                            data-error-message="nur ganze Zahlen erlaubt" name="Anzahl Personen 2025">
                        <span id="anzahlPersonen2025Error" class="error-message"></span>
                    </div>
                    <div class="formGroup">
                        <label for="gesamtStunden2025">Stunden gesamt im Projekt</label>
                        <input type="numbers" id="gesamtStunden2025" data-validate-regex="^\d+([.,]\d{1,2})?$"
                            data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="gesamt Stunden 2025">
                        <span id="gesamtStunden2025Error" class="error-message"></span>
                    </div>
                </div>


                <!-- 2026 -->
                <div class="formRow">
                    <div>2026</div>
                    <div class="formGroup">
                        <label for="anzahlPersonen2026">Anzahl Personen</label>
                        <input type="numbers" id="anzahlPersonen2026" data-validate-regex="^\d+$"
                            data-error-message="nur ganze Zahlen erlaubt" name="Anzahl Personen 2026">
                        <span id="anzahlPersonen2026Error" class="error-message"></span>
                    </div>
                    <div class="formGroup">
                        <label for="gesamtStunden2026">Stunden gesamt im Projekt</label>
                        <input type="numbers" id="gesamtStunden2026" data-validate-regex="^\d+([.,]\d{1,2})?$"
                            data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="gesamt Stunden 2026">
                        <span id="gesamtStunden2026Error" class="error-message"></span>
                    </div>
                </div>

                <!-- 2027 -->
                <div class="formRow">
                    <div>2027</div>
                    <div class="formGroup">
                        <label for="anzahlPersonen2027">Anzahl Personen</label>
                        <input type="numbers" id="anzahlPersonen2027" data-validate-regex="^\d+$"
                            data-error-message="nur ganze Zahlen erlaubt" name="Anzahl Personen 2027">
                        <span id="anzahlPersonen2027Error" class="error-message"></span>
                    </div>
                    <div class="formGroup">
                        <label for="gesamtStunden2027">Stunden gesamt im Projekt</label>
                        <input type="numbers" id="gesamtStunden2027" data-validate-regex="^\d+([.,]\d{1,2})?$"
                            data-error-message="nur ganze Zahlen und Dezimalzahlen erlaubt" name="gesamt Stunden 2027">
                        <span id="gesamtStunden2027Error" class="error-message"></span>
                    </div>
                </div>

                <!-- Submit -->
                <div class="formRow formRowRigth">
                    <button type="button" class="weiterButton" id="saveButton2">Hinzufügen</button>
                    <!-- save hinzugefügt-->
                </div>
            </form2>


            <!-- Sidebar mit den Buttons und zusammenfassung -->
            <aside class="sidebar">
                <button type="button" class="sidebarButton addButton" id="addButton">+ zu finanz. Mitarbeiter</button>
                <button type="button" class="sidebarButton addButton" id="addButton2">+ haushaltfinanz.
                    Mitarbeiter</button>
                <!--<button type="button" class="sidebarButton saveButton" id="saveButton">Mitarbeiter speichern</button>-->
                <!-- Mitarbeiter speichern geht hier nicht-->
                <div class="sidebarSummary">
                    <span class="summaryTitle">Summe der Personalkosten</span>
                    <ul class="summaryList" id="summaryList">
                </div>
                <div class="formRow formRowRigth">
                    <button type="submit" class="weiterButton" id="saveButton" style="display: block;">Weiter</button>
                    <button type="button" class="weiterButton" id="backButton"
                            style="display: none;">Zurück</button>
                </div>
            </aside>
            <!-- <script>
                // JavaScript für die Sidebar-Funktionalität
                document.querySelector('.addButton').addEventListener('click', function() {
                    // Logik zum Hinzufügen eines neuen Gegenstands
                    alert('Neue Person hinzugefügt!');
                });

                document.querySelector('.saveButton').addEventListener('click', function() {
                    // Logik zum Speichern des Gegenstands
                    alert('Mitarbeiter gespeichert!');
                });
            </script>
            -->
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Hochschule Mittweida</p>
        <canvas id="canvas"></canvas>
    </footer>
</body>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId') || localStorage.getItem("projectId");

        if (!projectId) {
            console.warn("Kein projectId vorhanden.");
            return;
        }

        //localStorage.setItem("projectId", projectId);

        fetch(`php/loadProject.php?projectId=${encodeURIComponent(projectId)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Fehler beim Laden: " + data.error);
                    return;
                }

                const summaryListElement = document.getElementById("summaryList");
                if (summaryListElement && data.B_summaryList) {
                    let items = [];
                    try {
                        items = JSON.parse(data.B_summaryList);
                    } catch (e) {
                        console.error("Fehler beim Parsen der Listendaten:", e);
                    }

                    summaryListElement.innerHTML = "";

                    items.forEach(itemText => {
                        const li = document.createElement("li");
                        li.textContent = itemText;
                        summaryListElement.appendChild(li);
                    });
                }
            })
            .catch(err => {
                console.error("Fehler beim Laden:", err);
                alert("Projekt konnte nicht geladen werden.");
            });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('form.projectForm');
        const submitButton = document.getElementById('submitButton');
        if (!form || !submitButton) return;

        submitButton.addEventListener('click', function (e) {
            e.preventDefault();


            const projectId = localStorage.getItem("projectId");
            if (!projectId) {
                alert("Projekt-ID fehlt.");
                return;
            }

            const formData = new FormData();
            const summaryList = document.getElementById("summaryList");
            if (summaryList) {
                const items = Array.from(summaryList.querySelectorAll("li")).map(li => li.textContent.trim());
                formData.append("B_summaryList", JSON.stringify(items));
                let totalSum = 0;
                items.forEach(itemText => {
                    const match = itemText.match(/([\d\.]+,\d{2})/);
                    if (match) {

                        let cleaned = match[1].replace(/\./g, "").replace(',', '.');
                        let num = parseFloat(cleaned);
                        if (!isNaN(num)) {
                            totalSum += num;
                        }
                    }
                });
                formData.append("G_sumPersonalkosten", totalSum);
            }
            formData.append("projectId", projectId);
            fetch("php/saveProject.php", {
                method: "POST",
                body: formData
            })
                .then(res => res.text())
                .then(result => {
                    console.log("Server response:", result);
                })
                .catch(err => {
                    console.error("Fehler beim Speichern:", err);
                    alert("Speichern fehlgeschlagen.");
                });
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const urlProjectId = urlParams.get('projectId');
        const localProjectId = localStorage.getItem("projectId");

        if (urlProjectId) {
            localStorage.setItem("projectId", urlProjectId);
        }

        const projectId = urlProjectId || localProjectId;

        if (!projectId) {
            console.warn("Keine projectId gefunden");
            return;
        }

        // Tabs updaten
        const links = document.querySelectorAll('.tabs a');
        links.forEach(link => {
            const url = new URL(link.href, window.location.origin);
            url.searchParams.set('projectId', projectId);
            link.href = url.toString();
        });

        // Dropdown-Optionen updaten
        const dropdown = document.getElementById("tabsDropdown");
        if (dropdown) {
            Array.from(dropdown.options).forEach(option => {
                if (option.value) {
                    const url = new URL(option.value, window.location.origin);
                    url.searchParams.set('projectId', projectId);
                    option.value = url.pathname + url.search;
                }
            });
        }
    });



</script>

</html>