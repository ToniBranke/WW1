<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalkosten</title>
    <link rel="stylesheet" href="style.css">
    <!--<script src="script.js"></script>-->
    <script src="buttonScript.js"></script>
</head>

<body class="taskMain">
    <div class="logoutButtonContainer">
        <button class="logoutButton" id="logoutButton">Abmelden</button>
    </div>
    <div class="tabsContainer">
        <div class="tabs" id="tabs">
            <!-- Buttons für demonstration auskommentiert und durch links ersetzt
                <button class="tab-active">Allgemeine Projektdaten</button>
                <button class="tab">Personalkosten</button>
                <button class="tab">Kosten für projektbezogene Leistungen</button>
                <button class="tab" >Sachkosten</button>
                <button class="tab">Investitionen/Abschreibungen auf Geräte und Ausstattung</button>
                <button class="tab">Kosten für Räume und Flächen</button>
            -->
            <a href="allgemein.html" class="tab">Allgemeine Projektdaten</a>
            <a href="personalkosten.html" class="tabActive">Personalkosten</a>
            <a href="leistungen.html" class="tab">Kosten für projektbezogene Leistungen</a>
            <a href="sachkosten.html" class="tab">Sachkosten</a>
            <a href="abschreibungen.html" class="tab">Investitionen/Abschreibungen auf Geräte und Ausstattung</a>
            <a href="raeume.html" class="tab">Kosten für Räume und Flächen</a>
        </div>
        <select class="tabsDropdown" id="tabsDropdown">
            <option value="allgemein.html">Allgemeine Projektdaten</option>
            <option vlaue="personalkosten.html">Personalkosten</option>
            <option value="leistungen.html" selected>Kosten für projektbezogene Leistungen</option>
            <option value="sachkosten.html">Sachkosten</option>
            <option value="abschreibungen.html">Investitionen/Abschreibungen auf Geräte und Ausstattung</option>
            <option value="raeume.html">Kosten für Räume und Flächen</option>
        </select>
    </div>
    <script>
        const tabs = document.getElementById('tabs');
        const dropdown = document.getElementById('tabsDropdown');

        const changeWidth = 1500;
        let tooSmall = window.innerWidth <= changeWidth;

        function animateSwitch(showDropdown) {
            if (showDropdown) {
                tabs.classList.add('tabsHidden');
                dropdown.classList.remove('dropdownHidden');
            } else {
                tabs.classList.remove('tabsHidden');
                dropdown.classList.add('dropdownHidden');
            }
        }

        window.addEventListener('resize', () => {
            const isSmall = window.innerWidth <= changeWidth;
            if (isSmall !== tooSmall) {
                animateSwitch(isSmall);
                tooSmall = isSmall;
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            if (tooSmall) {
                tabs.classList.add('tabsHidden');
                dropdown.classList.remove('dropdownHidden');
            } else {
                dropdown.classList.add('dropdownHidden');
            }

            requestAnimationFrame(() => {
                tabs.classList.add('navTransition');
                dropdown.classList.add('navTransition');
            });
        });

        dropdown.addEventListener('change', function () {
            window.location.href = this.value;
        });
    </script>
    <form class="projectForm">
        Durch Projekt zu finanzierende Mitarebeiter
        <div class="formRow">
            <div class="formGroup">
                <label for="shk">SHK:</label>
                <input type="number" id="shk" name="shk" min="0" placeholder="0">
                <span class="tooltipText">Studentische Hilfskraft ohne Hochschulabschluss</span>
            </div>
            <div class="formGroup">
                <label for="whk">WHK:</label>
                <input type="number" id="whk" name="whk" min="0" placeholder="0">
                <span class="tooltipText">Wissenschaftliche Hilfskraft mit erstem Hochschulabschluss</span>
            </div>
            <div class="formGroup">
                <label for="level">Stufe:</label>
                <input type="number" id="level" name="level" min="0" placeholder="0">
                <span class="tooltipText">Gemäß TV-L oder vergleichbarer tariflicher Regelung</span>
            </div>
        </div>
        <div class="formRow">
            <!-- Hier sollen die Jahre entfernt und gegen ein von bis getauscht werden -->
            <div class="formGroup">
                <label for="weeksInProject">Wochen im Projekt:</label>
                <div class="textBoxSmall">
                    <div class="formGroup">
                        <label for="2025">2025</label>
                        <input type="number" id="2025" name="2025" min="0" placeholder="0">
                        <span class="tooltipText">Anzahl der Wochen, die die Hilfskraft im jeweiligen Jahr
                            mitarbeitet</span>
                    </div>
                    <div class="formGroup">
                        <label for="2026">2026</label>
                        <input type="number" id="2026" name="2026" min="0" placeholder="0">
                    </div>
                    <div class="formGroup">
                        <label for="2027">2027</label>
                        <input type="number" id="2027" name="2027" min="0" placeholder="0">
                    </div>
                </div>
            </div>
        </div>
        </div>
        <div class="formRow">
            <div class="formGroup">
                <label for="weeklyHours">Wochenstunden:</label>
                <input type="number" id="weeklyHours" name="weeklyHours" min="0" placeholder="0">
                <span class="tooltipText">Durchschnitt an Arbeitsstunden pro Woche, die geleistet werden</span>
            </div>
        </div>
        <div class="formRow formRowRigth">
            <button type="submit" class="weiterButton" id="submitButton">Weiter</button>
        </div>
        </div>
    </form>
</body>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        let projectId = urlParams.get('projectId') || localStorage.getItem("projectId");

        if (!projectId) {
            console.warn("Kein projectId vorhanden.");
            return;
        }

        localStorage.setItem("projectId", projectId);

        fetch(`php/loadProject.php?projectId=${encodeURIComponent(projectId)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Fehler beim Laden: " + data.error);
                    return;
                }

                // Automatically populate matching input fields by ID
                Object.entries(data).forEach(([key, value]) => {
                    const el = document.getElementById(mapField(key));
                    if (el) {
                        el.value = value;
                    }
                });
            })
            .catch(err => {
                console.error("Fehler beim Laden:", err);
                alert("Projekt konnte nicht geladen werden.");
            });

        function mapField(dbKey) {
            const fieldMap = {
                "B_shk": "shk",
                "B_whk": "whk",
                "B_level": "level",
                "B_2025": "2025",
                "B_2026": "2026",
                "B_2027": "2027",
                "B_weeklyHours": "weeklyHours",
            };
            return fieldMap[dbKey] || dbKey; // fallback to same name
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('form.projectForm');
        const submitButton = document.getElementById('submitButton');
        const fieldMap = {
            shk: 'B_shk',
            whk: 'B_whk',
            level: 'B_level',
            "2025": 'B_2025',
            "2026": 'B_2026',
            "2027": 'B_2027',
            weeklyHours: 'B_weeklyHours',
        };

        if (!form || !submitButton) return;

        submitButton.addEventListener('click', function (e) {
            e.preventDefault(); // Prevent normal form submission


            const projectId = localStorage.getItem("projectId");
            if (!projectId) {
                alert("Projekt-ID fehlt.");
                return;
            }

            const formData = new FormData();
            for (const [htmlId, dbColumn] of Object.entries(fieldMap)) {
                const field = document.getElementById(htmlId);
                if (field) {
                    formData.append(dbColumn, field.value);
                }
            }

            formData.append("projectId", projectId);
            fetch("php/saveProject.php", {
                method: "POST",
                body: formData
            })
                .then(res => res.text())
                .then(result => {
                    console.log("Server response:", result);
                    window.location.href = "leistungen.html?projectId=" + encodeURIComponent(projectId);
                })
                .catch(err => {
                    console.error("Fehler beim Speichern:", err);
                    alert("Speichern fehlgeschlagen.");
                });
        });
    });
</script>

<footer class="footer">
    <p>&copy; 2025 Hochschule Mittweida</p>
</footer>

</html>